<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BWM Auto Shop</title>
    <link rel="icon"
        href="https://bigwestplayground.com/theultimatic/wp-content/uploads/dynamik-gen/theme/images/ultimatic-123.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.9.0/css/bulma.min.css"
        integrity="sha512-ADrqa2PY1TZtb/MoLZIZu/Z/LlPaWQeDMBV73EMwjGam43/JJ5fqW38Rq8LJOVGCDfrJeOMS3Q/wRUVzW5DkjQ=="
        crossorigin="anonymous" />
</head>

<body>
    <section class="hero">
        <div class="hero-body">
            <div class="container">
                <h1 class="title">
                    BWM Auto Shop
                </h1>
                <h2 class="subtitle">A user interface for Abe's Bots</h2>
                <br>
                <br>
                <p>Depending on the number of sites, each bot can take a little while.</p>
                <p>When the run is complete there will be a status message with a timestamp like "<em>MY_BOT_RUN</em> completed at Fri Aug 06 2021 14:32:22 GMT-0600 (Mountain Daylight Time)"</p>
            </div>
        </div>
    </section>
    <div class="container pb-5">

      <div class="notification">
        <label for="bot-select">Choose a bot &#x1F916; </label>
        <select name="bots" id="bot-select">
            <option value="none">-- &#x1F916; &#x1F916; &#x1F916; &#x1F916; &#x1F916; &#x1F916; &#x1F916; --</option>
            <option value="hscrape">Single-site H Scraper</option>
            <option value="seositecheck">SEO Site Check</option>
            <option value="lighthouse">Run Lighthouse</option>
            <option value="cfdns">Check Cloudflare and DNS</option>
        </select>

      </div>
      
      <div class="notification hscrape" style="display: none;">
          <h1 class="title">Single-site H Scraper</h1>
          <p>Input a URL to scrape the H1 and H2 tags for the site (use https://)</p>
          <br>
          <div class="field has-addons">
              <div class="control is-expanded">
                  <input class="input is-fullwidth" type="url" value="https://bigwestplayground.com/theultimatic"
                      id="h-url">
              </div>
              <div class="control">
                  <a class="button is-info" id="hscrape-run">
                      Scrape H tags
                  </a>
              </div>
          </div>
      </div>

        
        <div class="notification seositecheck" style="display: none;">
            <h1 class="title">SEO Site Check</h1>
            <p>Input a JSON array of URLs (use https://) to scrape the title, H1 and H2 tags, schema, social links, as well as desktop and mobile speed scores.</p>
            <br>
            <div id="file-js-example" class="file has-name">
                <label class="file-label">
                    <input class="file-input" type="file" name="">
                    <span class="file-cta">
                        <span class="file-icon">
                            <i class="fas fa-upload"></i>
                        </span>
                        <span class="file-label">
                            Choose a file…
                        </span>
                    </span>
                    <span class="file-name">
                    No file uploaded
                    </span>
                </label>
            </div>
        </div>

        <div class="notification lighthouse" style="display: none;">
            <h1 class="title">Run Lighthouse</h1>
            <p>Input a JSON array of URLs (use https://) to run lighthouse on</p>
            <button class="button is-info is-invisible" id="lh-check" >view progress</button>
            <button class="button is-info is-invisible" id="lh-reset" >reset</button>
            <div id="file-js-example-lh" class="file has-name">
                <label class="file-label">
                    <input class="file-input" type="file" name="">
                    <span class="file-cta">
                        <span class="file-icon">
                            <i class="fas fa-upload"></i>
                        </span>
                        <span class="file-label">
                            Choose a file…
                        </span>
                    </span>
                    <span class="file-name file-name-lh">
                    No file uploaded
                    </span>
                </label>
            </div>
        </div>

        <div class="notification cfdns" style="display: none;">
          <h1 class="title">Check Cloudflare and DNS</h1>
          <p>Input a JSON array of domains (no https://) to get the cloudflare status and DNS records</p>
          <br>
          <div id="file-js-example-cfdns" class="file has-name">
              <label class="file-label">
                  <input class="file-input" type="file" name="">
                  <span class="file-cta">
                      <span class="file-icon">
                          <i class="fas fa-upload"></i>
                      </span>
                      <span class="file-label">
                          Choose a file…
                      </span>
                  </span>
                  <span class="file-name">
                  No file uploaded
                  </span>
              </label>
          </div>
    </div>

    <div class="notification">
      <div class="websocket-test">
        <h1 class="title">Status</h1>
        <p id='pings'></p>
      </div>
      <br>
      <div id="results-container" style="max-height: 500px; overflow-y: scroll;"></div>
    </div>

    <footer class="footer">
        <div class="content has-text-centered">
            <p>
                well, that's it for now!~
            </p>
        </div>
    </footer>
    <script>
        (() => {
          // start things off by resetting data
          fetch(`/reset`)
          .then(response => response.json())
          .then(data => {
            resultsContainer.innerHTML = `<br><pre>${JSON.stringify(data, null, 2)}</pre>`
          }) 
          //websocket stuff
            const status = document.querySelector('#pings')
            const host = location.origin.replace(/^http/, 'ws')
            const ws = new WebSocket(host);
            ws.onmessage = function (event) {
            let obj = JSON.parse((event.data))
            let last_item = obj[obj.length - 1]
            if (last_item.message) {
              status.innerHTML = `${last_item.message}`
            } else if (last_item.data_type) {
              status.innerHTML = `currently checking ${last_item.data_type} on ${last_item.site}`
            } else if (item.in_cf) {
              status.innerHTML = `currently checking CF & DNS on ${last_item.site}`
            }
              resultsContainer.innerHTML = `<br><pre>${JSON.stringify(obj, null, 2)}</pre>`
            };
          
          // view progress and reset buttons
/*          const checkBtn = document.querySelector("#check")
          checkBtn.addEventListener("click", (e) => {
            fetch(`/check`)
            .then(response => response.json())
            .then(data => {
              resultsContainer.innerHTML = `<br><pre>${JSON.stringify(data, null, 2)}</pre>`
            }) 
          })
          const resetBtn = document.querySelector("#reset")  
          resetBtn.addEventListener("click", (e) => {
            fetch(`/reset`)
            .then(response => response.json())
            .then(data => {
              resultsContainer.innerHTML = `<br><pre>${JSON.stringify(data, null, 2)}</pre>`
            }) 
          }) */

          // bot select menu
          const botSelect = document.querySelector("#bot-select")
          const botContainer = document.querySelector('#bot-container');
          const resultsContainer = document.querySelector("#results-container")
          const bot_names = ["hscrape", "seositecheck", "lighthouse", "cfdns"]
          botSelect.addEventListener("change", (event) => {
            fetch(`/reset`)
            .then(response => response.json())
            .then(data => {
              resultsContainer.innerHTML = `<br><pre>${JSON.stringify(data, null, 2)}</pre>`
            }) 
            bot_names.forEach( (elem) => {
              if (event.target.value === elem) {
                document.querySelector(`.${elem}`).style.display = "block"
              } else {
                document.querySelector(`.${elem}`).style.display = "none"
              }
            })
          })

          // CF & DNS checker
          const fileInputCFDNS = document.querySelector('#file-js-example-cfdns input[type=file]');
          fileInputCFDNS.addEventListener("click", (e) => {
            fileInputCFDNS.value = ''
          })
          fileInputCFDNS.onchange = () => {
            if (fileInputCFDNS.files.length > 0) {
              const fileNameCFDNS = document.querySelector('#file-js-example-cfdns .file-name');
              const data = fileInputCFDNS.files[0];
              fileNameCFDNS.innerHTML = data.name;              
              fetch('/cfdns', {
                method: 'POST', // *GET, POST, PUT, DELETE, etc.
                mode: 'cors', // no-cors, *cors, same-origin
                cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
                credentials: 'same-origin', // include, *same-origin, omit
                headers: {
                  'Content-Type': 'application/json'
                  // 'Content-Type': 'application/x-www-form-urlencoded',
                },
                redirect: 'follow', // manual, *follow, error
                referrerPolicy: 'no-referrer', // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
                body: data // body data type must match "Content-Type" header
              })
              .then(response => response.json())
              .then(data => {
                resultsContainer.innerHTML += `<br><br><strong>${data.message}</strong>`;
              })
              .catch((error) => {
                console.error('Error:', JSON.stringify(error));
              });
            }
          }

            // Hscraper
          const hscrapeBtn = document.querySelector("#hscrape-run")
          hscrapeBtn.addEventListener("click", (e) => {
              const hscrapeUrl = document.querySelector("#h-url")
              const searchParams = new URLSearchParams()
              searchParams.set("url", hscrapeUrl.value)
              fetch(`/hscrape?${searchParams.toString()}`)
              .then(response => {
                  return response.json()
              })
              .then(function(data) {
                resultsContainer.innerHTML = `<br><pre>${JSON.stringify(data, null, 2)}</pre>`
              })
          })

          // sitecheck scraper
          const fileInput = document.querySelector('#file-js-example input[type=file]');
          fileInput.addEventListener("click", (e) => {
            fileInput.value = ''
          })
          fileInput.onchange = () => {
            if (fileInput.files.length > 0) {
            const fileName = document.querySelector('#file-js-example .file-name');
            fileName.innerHTML = fileInput.files[0].name;           
            const data = fileInput.files[0];
            fetch('/sitecheck', {
              method: 'POST', // *GET, POST, PUT, DELETE, etc.
              mode: 'cors', // no-cors, *cors, same-origin
              cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
              credentials: 'same-origin', // include, *same-origin, omit
              headers: {
                'Content-Type': 'application/json'
                // 'Content-Type': 'application/x-www-form-urlencoded',
              },
              redirect: 'follow', // manual, *follow, error
              referrerPolicy: 'no-referrer', // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
              body: data // body data type must match "Content-Type" header
            })
            .then(response => response.json())
            .then(data => {
              resultsContainer.innerHTML += `<br><br><strong>${data.message}</strong>`;
            })
            .catch((error) => {
              console.error('Error:', JSON.stringify(error));
            });
            }
          }

          // lighthouse
          const fileInputLH = document.querySelector('#file-js-example-lh input[type=file]');
          fileInputLH.onchange = () => {
            if (fileInputLH.files.length > 0) {
              const fileName = document.querySelector('#file-js-example-lh .file-name-lh');
              fileName.innerHTML = fileInputLH.files[0].name;
              const lhList = fileInputLH.files[0];
              fetch('/dolighthouse', {
                method: 'POST', // *GET, POST, PUT, DELETE, etc.
                mode: 'cors', // no-cors, *cors, same-origin
                cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
                credentials: 'same-origin', // include, *same-origin, omit
                headers: {
                  'Content-Type': 'application/json'
                  // 'Content-Type': 'application/x-www-form-urlencoded',
                },
                redirect: 'follow', // manual, *follow, error
                referrerPolicy: 'no-referrer', // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
                body: lhList // body data type must match "Content-Type" header
              })
              .then(response => response.json())
              .then(data => {
                resultsContainer.innerHTML += `<br><br><strong>${data.message}</strong>`;
              })
              .catch((error) => {
                console.error('Error:', JSON.stringify(error));
              });
            }
          }
        })()
    </script>

</body>

</html>